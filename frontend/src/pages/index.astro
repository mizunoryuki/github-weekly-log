---
import Layout from '../layouts/Layout.astro';
import WeeklyCharts from '../components/WeeklyCharts.astro';

const apiBase = import.meta.env.PUBLIC_WORKERS_API_BASE ?? '';
---

<Layout>
	<main class="page" data-api-base={apiBase}>
		<header class="hero">
			<p class="eyebrow">Weekly GitHub Activity</p>
			<h1>API-backed weekly stats</h1>
			<p class="lede">
				This page loads weekly summaries from the Workers API. If Access is enabled, you will
				be asked to sign in.
			</p>
		</header>

		<section class="panel">
			<div class="panel-header">
				<h2>Available periods</h2>
				<span id="status" class="status">Loading…</span>
			</div>
			<ul id="weekly-list" class="weekly-list"></ul>
		</section>

		<WeeklyCharts />
	</main>

	<script type="module">
		import {
			Chart,
			LineController,
			BarController,
			LineElement,
			BarElement,
			PointElement,
			CategoryScale,
			LinearScale,
			Title,
			Tooltip,
			Legend
		} from 'chart.js'

		Chart.register(
			LineController,
			BarController,
			LineElement,
			BarElement,
			PointElement,
			CategoryScale,
			LinearScale,
			Title,
			Tooltip,
			Legend
		)

		const root = document.querySelector('[data-api-base]')
		const apiBase = root?.getAttribute('data-api-base')?.replace(/\/$/, '')
		const statusEl = document.getElementById('status')
		const listEl = document.getElementById('weekly-list')
		const selectorEl = document.getElementById('period-selector')
		const chartsContent = document.getElementById('charts-content')

		let charts = { daily: null, hourly: null, repos: null, languages: null }

		const setStatus = (text) => {
			if (statusEl) statusEl.textContent = text
		}

		const renderItems = (items) => {
			if (!listEl || !selectorEl) return
			listEl.innerHTML = ''
			selectorEl.innerHTML = '<option value="">Select a period...</option>'

			items.forEach((item) => {
				const li = document.createElement('li')
				li.className = 'weekly-item'
				li.innerHTML = `
					<div class="item-range">
						<span>${item.start_date} → ${item.end_date}</span>
						<small>ID: ${item.id}</small>
					</div>
					<div class="item-metrics">
						<span>${item.total_commits} commits</span>
						<span>${item.active_days} active days</span>
					</div>
				`
				listEl.appendChild(li)

				const option = document.createElement('option')
				option.value = item.id
				option.textContent = `${item.start_date} → ${item.end_date}`
				selectorEl.appendChild(option)
			})
		}

		const destroyCharts = () => {
			Object.values(charts).forEach((chart) => chart?.destroy())
			charts = { daily: null, hourly: null, repos: null, languages: null }
		}

		const renderCharts = (data) => {
			destroyCharts()
			if (chartsContent) chartsContent.style.display = 'grid'

			const dailyCanvas = document.getElementById('daily-chart')
			const hourlyCanvas = document.getElementById('hourly-chart')
			const reposCanvas = document.getElementById('repos-chart')
			const languagesCanvas = document.getElementById('languages-chart')

			if (dailyCanvas && data.daily) {
				charts.daily = new Chart(dailyCanvas, {
					type: 'line',
					data: {
						labels: data.daily.labels,
						datasets: [
							{
								label: 'Commits',
								data: data.daily.data,
								borderColor: '#3245ff',
								backgroundColor: 'rgba(50, 69, 255, 0.1)',
								tension: 0.3,
								fill: true
							}
						]
					},
					options: {
						responsive: true,
						maintainAspectRatio: true,
						plugins: { legend: { display: false } }
					}
				})
			}

			if (hourlyCanvas && data.hourly) {
				charts.hourly = new Chart(hourlyCanvas, {
					type: 'bar',
					data: {
						labels: data.hourly.labels,
						datasets: [
							{
								label: 'Commits',
								data: data.hourly.data,
								backgroundColor: '#bc52ee'
							}
						]
					},
					options: {
						responsive: true,
						maintainAspectRatio: true,
						plugins: { legend: { display: false } }
					}
				})
			}

			if (reposCanvas && data.repos) {
				charts.repos = new Chart(reposCanvas, {
					type: 'bar',
					data: {
						labels: data.repos.labels,
						datasets: [
							{
								label: 'Commits',
								data: data.repos.data,
								backgroundColor: '#f041ff'
							}
						]
					},
					options: {
						indexAxis: 'y',
						responsive: true,
						maintainAspectRatio: true,
						plugins: { legend: { display: false } }
					}
				})
			}

			if (languagesCanvas && data.languages) {
				charts.languages = new Chart(languagesCanvas, {
					type: 'bar',
					data: {
						labels: data.languages.labels,
						datasets: [
							{
								label: 'Commits',
								data: data.languages.data,
								backgroundColor: '#d83333'
							}
						]
					},
					options: {
						responsive: true,
						maintainAspectRatio: true,
						plugins: { legend: { display: false } }
					}
				})
			}
		}

		const loadWeeklyDetail = async (id) => {
			try {
				const response = await fetch(`${apiBase}/api/weekly/${id}`, {
					credentials: 'include'
				})
				if (!response.ok) {
					throw new Error(`HTTP ${response.status}`)
				}
				const data = await response.json()
				renderCharts(data)
			} catch (error) {
				console.error('Failed to load detail:', error)
			}
		}

		const loadWeekly = async () => {
			if (!apiBase) {
				setStatus('Missing PUBLIC_WORKERS_API_BASE')
				return
			}

			try {
				const response = await fetch(`${apiBase}/api/weekly`, {
					credentials: 'include'
				})
				if (!response.ok) {
					throw new Error(`HTTP ${response.status}`)
				}

				const data = await response.json()
				renderItems(data.items ?? [])
				setStatus(`Loaded ${data.items?.length ?? 0} periods`)

				// Auto-load first period
				if (data.items?.length > 0 && selectorEl) {
					selectorEl.value = data.items[0].id
					await loadWeeklyDetail(data.items[0].id)
				}
			} catch (error) {
				const message = error instanceof Error ? error.message : 'Request failed'
				setStatus(message)
			}
		}

		if (selectorEl) {
			selectorEl.addEventListener('change', (e) => {
				const id = e.target.value
				if (id) {
					loadWeeklyDetail(id)
				} else {
					destroyCharts()
					if (chartsContent) chartsContent.style.display = 'none'
				}
			})
		}

		loadWeekly()
	</script>
</Layout>

<style>
	:global(body) {
		background: radial-gradient(circle at top, #f0ede7 0%, #efe9e0 35%, #f7f4ef 100%);
		color: #1e1b16;
		font-family: 'Newsreader', 'Iowan Old Style', 'Palatino Linotype', 'Book Antiqua', Palatino,
			serif;
	}

	.page {
		min-height: 100vh;
		padding: 72px 8vw 96px;
		display: grid;
		gap: 48px;
	}

	.hero h1 {
		font-size: clamp(2.6rem, 4vw, 3.6rem);
		margin: 12px 0;
		letter-spacing: -0.02em;
	}

	.eyebrow {
		text-transform: uppercase;
		letter-spacing: 0.18em;
		font-size: 0.75rem;
		color: #7b5f3b;
		margin: 0;
	}

	.lede {
		max-width: 640px;
		font-size: 1.1rem;
		line-height: 1.7;
		color: #3a2f24;
	}

	.panel {
		background: rgba(255, 255, 255, 0.8);
		border: 1px solid rgba(110, 88, 60, 0.2);
		border-radius: 20px;
		padding: 24px;
		box-shadow: 0 30px 80px rgba(64, 48, 32, 0.1);
	}

	.panel-header {
		display: flex;
		align-items: baseline;
		justify-content: space-between;
		gap: 16px;
		margin-bottom: 16px;
	}

	.panel h2 {
		font-size: 1.35rem;
		margin: 0;
	}

	.status {
		font-size: 0.9rem;
		color: #6c5640;
	}

	.weekly-list {
		list-style: none;
		padding: 0;
		margin: 0;
		display: grid;
		gap: 14px;
	}

	.weekly-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 16px;
		padding: 16px 18px;
		border-radius: 14px;
		background: #fbfaf7;
		border: 1px solid rgba(110, 88, 60, 0.15);
	}

	.item-range {
		display: flex;
		flex-direction: column;
		gap: 6px;
		font-weight: 600;
	}

	.item-range small {
		font-size: 0.8rem;
		color: #8a6d4a;
	}

	.item-metrics {
		display: flex;
		gap: 16px;
		font-size: 0.95rem;
		color: #4b3a2a;
	}

	@media (max-width: 720px) {
		.page {
			padding: 48px 6vw 72px;
		}

		.weekly-item {
			flex-direction: column;
			align-items: flex-start;
		}
	}
</style>
